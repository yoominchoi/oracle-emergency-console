import streamlit as st
import cx_Oracle

def get_db_connection():
    dsn = cx_Oracle.makedsn("localhost", 1521, service_name="freepdb1")
    conn = cx_Oracle.connect(user="user1", password="yoominchoi1234A", dsn=dsn)
    return conn

def init_db():
    conn = get_db_connection()
    cursor = conn.cursor()
    
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users (
            id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            name VARCHAR2(100) NOT NULL,
            user_type CHAR(1) CHECK (user_type IN ('G', 'A')) NOT NULL,
            is_safe CHAR(1) CHECK (is_safe IN ('Y', 'N')),
            is_urgent CHAR(1) CHECK (is_urgent IN ('Y', 'N'))
        )
    """)
    
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS incident_details (
            incident_id NUMBER PRIMARY KEY REFERENCES incidents(id),
            timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
            updated_by NUMBER REFERENCES users(id),
            shooter_location VARCHAR2(255),
            shooter_desc VARCHAR2(255),
            alert_msg VARCHAR2(100)
        )
    """)

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS incidents (
            id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY
        )
    """)
    
    # cursor.execute("""
    #     CREATE TABLE IF NOT EXISTS people_status (
    #         incident_id NUMBER PRIMARY KEY REFERENCES incidents(id),
    #         safe_count NUMBER DEFAULT 0,
    #         unsafe_count NUMBER DEFAULT 0,
    #         urgent_list CLOB
    #     )
    # """)
    
    conn.commit()
    cursor.close()
    conn.close()

def fetch_users():
    conn = get_db_connection()
    cursor = conn.cursor()

    cursor.execute("SELECT id, name, user_type FROM users")
    rows = cursor.fetchall()
    cursor.close()
    conn.close()

    return rows

def fetch_incidents():
    conn = get_db_connection()
    cursor = conn.cursor()
    
    cursor.execute("""
        SELECT i.timestamp, u.name as updated_by, i.shooter_location, i.alert_msg 
        FROM incident_details i 
        LEFT JOIN users u ON i.updated_by = u.id 
        ORDER BY i.timestamp DESC
    """)
    rows = cursor.fetchall()
    cursor.close()
    conn.close()
    
    return rows

def update_user(user_id, column, value):
    conn = get_db_connection()
    cursor = conn.cursor()
    
    if value in ['Y', 'N']:
        valid_columns = ['is_safe', 'is_urgent']
        if column not in valid_columns:
            raise ValueError("Invalid column name.")
        query = f"""
            UPDATE users
            SET {column} = :value
            WHERE id = :user_id
        """
        cursor.execute(query, {'value': value, 'user_id': user_id})

    get_overall_status(cursor)

    conn.commit()
    cursor.close()
    conn.close()

def get_user_status(user_id):
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT is_safe, is_urgent FROM users WHERE id = :user_id", {'user_id': user_id})
    result = cursor.fetchone()
    print('user_status', result[0])
    conn.close()
    return result
    

def get_overall_status(cursor):
    # Total # of users
    cursor.execute("SELECT COUNT(*) FROM users u WHERE u.user_type = 'G'")
    total_users = cursor.fetchone()
    print('total_users', total_users[0])

    # Total # of safe users
    cursor.execute("""
        SELECT COUNT(*)
        FROM users u
        WHERE u.user_type = 'G' and u.is_safe = 'Y'
    """)
    safe_count = cursor.fetchone()
    print('safe_count', safe_count[0])
    
    # Total # of unsafe users
    cursor.execute("""
        SELECT COUNT(*)
        FROM users u
        WHERE u.user_type = 'G' and u.is_safe = 'N'
    """)
    unsafe_count = cursor.fetchone()
    print('unsafe_count', unsafe_count[0])

    # Total # of urgent users
    cursor.execute("""
        SELECT COUNT(*)
        FROM users u
        WHERE u.user_type = 'G' and u.is_urgent = 'Y'
    """)
    urgent_count = cursor.fetchone()
    print('urgent users', urgent_count[0])

    # Total # of not urgent users
    cursor.execute("""
        SELECT COUNT(*)
        FROM users u
        WHERE u.user_type = 'G' and u.is_urgent = 'N'
    """)
    not_urgent_count = cursor.fetchone()
    print('not urgent users', not_urgent_count[0])


def update_incident(incident_id, user_id, column, value):
    conn = get_db_connection()
    cursor = conn.cursor()
    if value != '' and value != None and value != '<NA>':
        if column == "shooter_location":
            cursor.execute("""
                INSERT INTO incident_details (incident_id, updated_by, shooter_location) 
                VALUES (:incident_id, :user_id, :value)
            """, {'incident_id': incident_id, 'user_id': user_id, 'value': value})
        elif column == "alert_msg":
            cursor.execute("""
                INSERT INTO incident_details (incident_id, updated_by, alert_msg)
                VALUES (:incident_id, :user_id, :value)
            """, {'incident_id': incident_id, 'user_id': user_id, 'value': value})
        else:
            query = f"""
                UPDATE incident_details 
                SET {column} = :value, updated_by = :user_id, timestamp = SYSTIMESTAMP
                WHERE id = (SELECT id FROM incident_details WHERE rownum = 1 ORDER BY timestamp DESC)
            """
            cursor.execute(query, {'value':value, 'user_id':user_id})
    conn.commit()
    cursor.close()
    conn.close()
    if value != '' and value != None and value != '<NA>':
        st.rerun()